import{d as Y,u as Z,s as $,r as c,j as Q,k as ee,l as te,m as k,c as h,a as n,t as ae,p as L,F as S,e as U,q as I,w as C,x as M,i as B,K as le,b as se,v as ne,f as oe,n as ie,y as re,o as v,z as ue,_ as ce}from"./index-CCyrc4BV.js";import{L as E,s as ve,c as de,M as pe}from"./chat-ClvzFsdR.js";import{i as fe,f as ge,u as he,U as me,r as _e}from"./index-7B8ir-Fl.js";const ye={class:"header"},we={class:"input-box"},xe={class:"input-wrapper"},Ce={key:0,class:"filearea-wrapper"},be={class:"textarea-wrapper"},ke={class:"button-wrapper"},Le=Y({__name:"ChatView",props:{conversationdId:{}},setup(K){const q=Z(),{firstSendQuery:D,firstSendFiles:b,streamingConversationId:F,messages:o,conversation_id:H,conversationList:N,detailMessageList:z,isRegenerate:R}=$(q),m=c(""),A=c(""),r=c(null),p=c(null),d=c(!1),u=c([]),f=c(""),_=c(!1),y=c(!0),V=c(!1),g=K,O=Q(()=>{const t=N.value.find(e=>e.coversation_id===g.conversationdId);return t==null?void 0:t.title}),j=async()=>{const t=m.value.trim();if(!t)return;console.log(t);const e=u.value;u.value=[],e.length>0?o.value.push({role:"user",content:t,files:e,content_type:"object_string"}):o.value.push({role:"user",content:t,content_type:"text"}),m.value="",await w(t,e)},w=async(t,e)=>{F.value=g.conversationdId,f.value="",d.value=!0,_.value=!1,y.value=!0,re(()=>{var l;(l=r.value)==null||l.scrollTo({top:r.value.scrollHeight,behavior:"smooth"})});let a="text",i=t;const s=[];e.length>0&&(a="object_string",e.forEach(l=>{fe(l.name)?s.push({type:"image",file_id:l.id}):s.push({type:"file",file_id:l.id})}),s.push({type:"text",text:t}),i=s),console.log("final_query:",i),await ve({final_query:i,content_type:a,conversation_id:g.conversationdId,callback:l=>{l.role==="assistant"&&!_.value&&(f.value+=l.content||"")},onChatCreated(l){A.value=l,console.log("chat created:",l)},isCancelled:()=>_.value}),_.value||(o.value.push({role:"assistant",content:f.value,content_type:"text"}),d.value=!1),console.log("cur messages:",o.value)},G=t=>{t.shiftKey||(t.preventDefault(),j())},J=async()=>{_.value=!0;const t=await de({conversation_id:g.conversationdId,chat_id:A.value});console.log("canceled chat info:",t),o.value.push({role:"assistant",content:f.value,content_type:"text"}),f.value="",d.value=!1},P=()=>{var t;console.log("上传附件中"),(t=p.value)==null||t.click()},W=async()=>{if(p.value&&p.value.files&&p.value.files.length>0){const t=Array.from(p.value.files);console.log("文件列表:",t);for(const e of t){if(u.value.find(i=>i.name===e.name)){console.log("不要上传重复的文件!");continue}u.value.push({id:"",name:e.name,size:ge(e.size),isparsing:!1});const a=await he(e);u.value=u.value.map(i=>(i.name===e.name&&(i.isparsing=!0,i.id=a.id),i)),console.log("上传文件结果:",a),p.value.value=""}}},X=t=>{const e=u.value.findIndex(a=>a.name===t);e!==-1&&u.value.splice(e,1)},T=()=>{r.value&&(r.value.scrollTop+r.value.clientHeight<r.value.scrollHeight-30?y.value=!1:y.value=!0)};return ee(()=>{r.value&&r.value.addEventListener("scroll",T)}),te(()=>{r.value&&r.value.addEventListener("scroll",T)}),k([()=>g.conversationdId,D],async([t,e])=>{if(e)V.value||(V.value=!0,e&&(b.value.length>0?o.value.push({role:"user",content:e,files:b.value,content_type:"object_string"}):o.value.push({role:"user",content:e,content_type:"text"})),await w(e,b.value));else if(t){const a=await ue(t);z.value=a.data,console.log("coversation messages:",z.value);const i=Object.values(a.data.reduce((s,l)=>{var x;return(s[x=l.chat_id]||(s[x]=[])).push(l),s},{})).sort((s,l)=>s[0].created_at-l[0].created_at).flatMap(s=>s.sort((l,x)=>x.type==="answer"?-1:1));o.value=i.map(s=>{if(s.content_type==="object_string"){const l=JSON.parse(s.content);return _e(l)}else return{role:s.role,content:s.content,content_type:s.content_type}})}H.value=g.conversationdId||""},{immediate:!0}),k(f,()=>{r.value&&y.value&&(r.value.scrollTop=r.value.scrollHeight)}),k(()=>R.value,async()=>{const t=o.value[o.value.length-2].content;o.value.pop();let e=[];o.value[o.value.length-1].content_type==="object_string"&&(e=o.value[o.value.length-1].files),await w(t,e)}),(t,e)=>(v(),h(S,null,[n("div",ye,ae(O.value),1),n("div",{class:"chat-list",ref_key:"chatListRef",ref:r},[(v(!0),h(S,null,U(I(o),(a,i)=>(v(),h("div",{key:i},[a.role==="user"?(v(),L(pe,{key:0,message:a.content,files:a.files||[],onGenerateChat:w},null,8,["message","files"])):(v(),L(E,{key:1,answer:a.content,isStreaming:d.value,isLast:i===I(o).length-1},null,8,["answer","isStreaming","isLast"]))]))),128)),(v(),L(le,null,[C(B(E,{answer:f.value,isStreaming:d.value},null,8,["answer","isStreaming"]),[[M,d.value&&I(F)===g.conversationdId]])],1024))],512),n("div",we,[n("div",xe,[u.value.length>0?(v(),h("div",Ce,[(v(!0),h(S,null,U(u.value,(a,i)=>(v(),h("div",{key:i},[B(me,{name:a.name,size:a.size,isparsing:a.isparsing,onDeleteFile:X},null,8,["name","size","isparsing"])]))),128))])):se("",!0),n("div",be,[C(n("textarea",{"onUpdate:modelValue":e[0]||(e[0]=a=>m.value=a),name:"input-area",placeholder:"请输入要询问的问题",id:"input-area",onKeydown:oe(G,["enter"])},null,544),[[ne,m.value]])]),n("div",ke,[n("input",{ref_key:"fileInput",ref:p,type:"file",multiple:"",accept:".doc,.docx,.xls,.xlsx,.ppt,.pptx,.pdf,.csv,.jpg,.png,.gif,.webp,.bmp,.pcd,.tiff",style:{display:"none"},onChange:W},null,544),n("div",{class:"attach btn",onClick:P},e[1]||(e[1]=[n("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 14 20",fill:"none"},[n("path",{d:"M7 20c-1.856-.002-3.635-.7-4.947-1.94C.74 16.819.003 15.137 0 13.383V4.828a4.536 4.536 0 0 1 .365-1.843 4.75 4.75 0 0 1 1.087-1.567A5.065 5.065 0 0 1 3.096.368a5.293 5.293 0 0 1 3.888 0c.616.244 1.174.6 1.643 1.05.469.45.839.982 1.088 1.567.25.586.373 1.212.364 1.843v8.555a2.837 2.837 0 0 1-.92 2.027A3.174 3.174 0 0 1 7 16.245c-.807 0-1.582-.3-2.158-.835a2.837 2.837 0 0 1-.92-2.027v-6.22a1.119 1.119 0 1 1 2.237 0v6.22a.777.777 0 0 0 .256.547.868.868 0 0 0 .585.224c.219 0 .429-.08.586-.224a.777.777 0 0 0 .256-.546V4.828A2.522 2.522 0 0 0 7.643 3.8a2.64 2.64 0 0 0-.604-.876 2.816 2.816 0 0 0-.915-.587 2.943 2.943 0 0 0-2.168 0 2.816 2.816 0 0 0-.916.587 2.64 2.64 0 0 0-.604.876 2.522 2.522 0 0 0-.198 1.028v8.555c0 1.194.501 2.339 1.394 3.183A4.906 4.906 0 0 0 7 17.885a4.906 4.906 0 0 0 3.367-1.319 4.382 4.382 0 0 0 1.395-3.183v-6.22a1.119 1.119 0 0 1 2.237 0v6.22c-.002 1.754-.74 3.436-2.052 4.677C10.635 19.3 8.856 19.998 7 20z",fill:"currentColor"})],-1)])),C(n("div",{class:ie(["send btn",m.value.trim()?"active":""]),onClick:j},e[2]||(e[2]=[n("svg",{width:"14",height:"16",viewBox:"0 0 14 16",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[n("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M7 16c-.595 0-1.077-.462-1.077-1.032V1.032C5.923.462 6.405 0 7 0s1.077.462 1.077 1.032v13.936C8.077 15.538 7.595 16 7 16z",fill:"currentColor"}),n("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M.315 7.44a1.002 1.002 0 0 1 0-1.46L6.238.302a1.11 1.11 0 0 1 1.523 0c.421.403.421 1.057 0 1.46L1.838 7.44a1.11 1.11 0 0 1-1.523 0z",fill:"currentColor"}),n("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M13.685 7.44a1.11 1.11 0 0 1-1.523 0L6.238 1.762a1.002 1.002 0 0 1 0-1.46 1.11 1.11 0 0 1 1.523 0l5.924 5.678c.42.403.42 1.056 0 1.46z",fill:"currentColor"})],-1)]),2),[[M,!d.value]]),C(n("div",{class:"stop btn",onClick:J},e[3]||(e[3]=[n("div",{class:"box"},null,-1)]),512),[[M,d.value]])])]),e[4]||(e[4]=n("div",{class:"bottom-info"},"内容由 AI 生成，请仔细甄别",-1))])],64))}}),Fe=ce(Le,[["__scopeId","data-v-55889cf7"]]);export{Fe as default};
