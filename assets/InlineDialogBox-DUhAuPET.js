import{I as G,i as g,d as Q,r as c,u as Z,s as $,k as J,l as O,m as I,c as d,a as t,b as V,q as S,F as z,e as U,w as C,v as P,f as X,x as M,n as Y,p as F,K as ee,g as le,y as ae,o as u,_ as te}from"./index-CCyrc4BV.js";import{L as D,s as se,c as ne,M as oe}from"./chat-ClvzFsdR.js";import{i as ie,f as re,u as ue,U as ce}from"./index-7B8ir-Fl.js";const ve=G("search",!0,function(s){return g("svg",{width:s.size,height:s.size,viewBox:"0 0 48 48",fill:"none"},[g("path",{d:"M21 38C30.3888 38 38 30.3888 38 21C38 11.6112 30.3888 4 21 4C11.6112 4 4 11.6112 4 21C4 30.3888 11.6112 38 21 38Z",fill:s.colors[1],stroke:s.colors[0],"stroke-width":s.strokeWidth,"stroke-linejoin":s.strokeLinejoin},null),g("path",{d:"M26.657 14.3431C25.2093 12.8954 23.2093 12 21.0001 12C18.791 12 16.791 12.8954 15.3433 14.3431",stroke:s.colors[2],"stroke-width":s.strokeWidth,"stroke-linecap":s.strokeLinecap,"stroke-linejoin":s.strokeLinejoin},null),g("path",{d:"M33.2216 33.2217L41.7069 41.707",stroke:s.colors[0],"stroke-width":s.strokeWidth,"stroke-linecap":s.strokeLinecap,"stroke-linejoin":s.strokeLinejoin},null)])}),de={class:"container"},fe={class:"dialog-container"},pe={class:"input-box"},he={class:"input-wrapper"},ge={key:0,class:"filearea-wrapper"},me={class:"textarea-wrapper"},we={class:"button-wrapper"},ye={key:1,class:"history-list"},ke=Q({__name:"InlineDialogBox",setup(s){const x=c(!1),m=c(""),j=c(""),i=c(null),p=c(null),f=c(!1),v=c([]),h=c(""),w=c(!1),y=c(!0),L=c(!1),K=Z(),{messages:n,conversation_id:k,isRegenerate:T}=$(K),q=l=>{l.target.classList.contains("dialog-overlay")&&(x.value=!1,k.value="",m.value="",n.value=[])},A=async()=>{const l=m.value.trim();if(!l)return;console.log(l);const e=v.value;if(v.value=[],L.value===!1){const a=await le();k.value=a.id,L.value=!0}e.length>0?n.value.push({role:"user",content:l,files:e,content_type:"object_string"}):n.value.push({role:"user",content:l,content_type:"text"}),m.value="",await b(l,e)},b=async(l,e)=>{h.value="",f.value=!0,w.value=!1,y.value=!0,ae(()=>{var r;(r=i.value)==null||r.scrollTo({top:i.value.scrollHeight,behavior:"smooth"})});let a="text",o=l;const _=[];e.length>0&&(a="object_string",e.forEach(r=>{ie(r.name)?_.push({type:"image",file_id:r.id}):_.push({type:"file",file_id:r.id})}),_.push({type:"text",text:l}),o=_),console.log("final_query:",o),await se({final_query:o,content_type:a,conversation_id:k.value,callback:r=>{r.role==="assistant"&&!w.value&&(h.value+=r.content||"")},onChatCreated(r){j.value=r,console.log("chat created:",r)},isCancelled:()=>w.value}),w.value||(n.value.push({role:"assistant",content:h.value,content_type:"text"}),f.value=!1),console.log("cur messages:",n.value)},E=l=>{l.shiftKey||(l.preventDefault(),A())},H=async()=>{w.value=!0;const l=await ne({conversation_id:k.value,chat_id:j.value});console.log("canceled chat info:",l),n.value.push({role:"assistant",content:h.value,content_type:"text"}),h.value="",f.value=!1},R=()=>{var l;console.log("上传附件中"),(l=p.value)==null||l.click()},W=async()=>{if(p.value&&p.value.files&&p.value.files.length>0){const l=Array.from(p.value.files);console.log("文件列表:",l);for(const e of l){if(v.value.find(o=>o.name===e.name)){console.log("不要上传重复的文件!");continue}v.value.push({id:"",name:e.name,size:re(e.size),isparsing:!1});const a=await ue(e);v.value=v.value.map(o=>(o.name===e.name&&(o.isparsing=!0,o.id=a.id),o)),console.log("上传文件结果:",a),p.value.value=""}}},N=l=>{const e=v.value.findIndex(a=>a.name===l);e!==-1&&v.value.splice(e,1)},B=()=>{i.value&&(i.value.scrollTop+i.value.clientHeight<i.value.scrollHeight-30?y.value=!1:y.value=!0)};return J(()=>{i.value&&i.value.addEventListener("scroll",B)}),O(()=>{i.value&&i.value.addEventListener("scroll",B)}),I(h,()=>{i.value&&y.value&&(i.value.scrollTop=i.value.scrollHeight)}),I(()=>T.value,async()=>{const l=n.value[n.value.length-2].content;n.value.pop();let e=[];n.value[n.value.length-1].content_type==="object_string"&&(e=n.value[n.value.length-1].files),await b(l,e)}),(l,e)=>(u(),d(z,null,[t("div",de,[t("button",{class:"launcher",onClick:e[0]||(e[0]=a=>x.value=!0)},[g(S(ve),{size:"18",style:{height:"16px",width:"16px",margin:"0 10px"}}),e[2]||(e[2]=t("span",null,"请输入要询问的问题",-1))])]),x.value?(u(),d("div",{key:0,class:"dialog-overlay",onClick:q},[t("div",fe,[t("div",pe,[t("div",he,[v.value.length>0?(u(),d("div",ge,[(u(!0),d(z,null,U(v.value,(a,o)=>(u(),d("div",{key:o},[g(ce,{name:a.name,size:a.size,isparsing:a.isparsing,onDeleteFile:N},null,8,["name","size","isparsing"])]))),128))])):V("",!0),t("div",me,[C(t("textarea",{"onUpdate:modelValue":e[1]||(e[1]=a=>m.value=a),name:"input-area",placeholder:"请输入要询问的问题",id:"input-area",onKeydown:X(E,["enter"])},null,544),[[P,m.value]])]),t("div",we,[t("input",{ref_key:"fileInput",ref:p,type:"file",multiple:"",accept:".doc,.docx,.xls,.xlsx,.ppt,.pptx,.pdf,.csv,.jpg,.png,.gif,.webp,.bmp,.pcd,.tiff",style:{display:"none"},onChange:W},null,544),t("div",{class:"attach btn",onClick:R},e[3]||(e[3]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 14 20",fill:"none"},[t("path",{d:"M7 20c-1.856-.002-3.635-.7-4.947-1.94C.74 16.819.003 15.137 0 13.383V4.828a4.536 4.536 0 0 1 .365-1.843 4.75 4.75 0 0 1 1.087-1.567A5.065 5.065 0 0 1 3.096.368a5.293 5.293 0 0 1 3.888 0c.616.244 1.174.6 1.643 1.05.469.45.839.982 1.088 1.567.25.586.373 1.212.364 1.843v8.555a2.837 2.837 0 0 1-.92 2.027A3.174 3.174 0 0 1 7 16.245c-.807 0-1.582-.3-2.158-.835a2.837 2.837 0 0 1-.92-2.027v-6.22a1.119 1.119 0 1 1 2.237 0v6.22a.777.777 0 0 0 .256.547.868.868 0 0 0 .585.224c.219 0 .429-.08.586-.224a.777.777 0 0 0 .256-.546V4.828A2.522 2.522 0 0 0 7.643 3.8a2.64 2.64 0 0 0-.604-.876 2.816 2.816 0 0 0-.915-.587 2.943 2.943 0 0 0-2.168 0 2.816 2.816 0 0 0-.916.587 2.64 2.64 0 0 0-.604.876 2.522 2.522 0 0 0-.198 1.028v8.555c0 1.194.501 2.339 1.394 3.183A4.906 4.906 0 0 0 7 17.885a4.906 4.906 0 0 0 3.367-1.319 4.382 4.382 0 0 0 1.395-3.183v-6.22a1.119 1.119 0 0 1 2.237 0v6.22c-.002 1.754-.74 3.436-2.052 4.677C10.635 19.3 8.856 19.998 7 20z",fill:"currentColor"})],-1)])),C(t("div",{class:Y(["send btn",m.value.trim()?"active":""]),onClick:A},e[4]||(e[4]=[t("svg",{width:"14",height:"16",viewBox:"0 0 14 16",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[t("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M7 16c-.595 0-1.077-.462-1.077-1.032V1.032C5.923.462 6.405 0 7 0s1.077.462 1.077 1.032v13.936C8.077 15.538 7.595 16 7 16z",fill:"currentColor"}),t("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M.315 7.44a1.002 1.002 0 0 1 0-1.46L6.238.302a1.11 1.11 0 0 1 1.523 0c.421.403.421 1.057 0 1.46L1.838 7.44a1.11 1.11 0 0 1-1.523 0z",fill:"currentColor"}),t("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M13.685 7.44a1.11 1.11 0 0 1-1.523 0L6.238 1.762a1.002 1.002 0 0 1 0-1.46 1.11 1.11 0 0 1 1.523 0l5.924 5.678c.42.403.42 1.056 0 1.46z",fill:"currentColor"})],-1)]),2),[[M,!f.value]]),C(t("div",{class:"stop btn",onClick:H},e[5]||(e[5]=[t("div",{class:"box"},null,-1)]),512),[[M,f.value]])])])]),L.value?(u(),d("div",{key:0,class:"chat-list",ref_key:"chatListRef",ref:i},[(u(!0),d(z,null,U(S(n),(a,o)=>(u(),d("div",{key:o},[a.role==="user"?(u(),F(oe,{key:0,message:a.content,files:a.files||[],onGenerateChat:b},null,8,["message","files"])):(u(),F(D,{key:1,answer:a.content,isStreaming:f.value,isLast:o===S(n).length-1},null,8,["answer","isStreaming","isLast"]))]))),128)),(u(),F(ee,null,[C(g(D,{answer:h.value,isStreaming:f.value},null,8,["answer","isStreaming"]),[[M,f.value]])],1024))],512)):(u(),d("div",ye))])])):V("",!0)],64))}}),Le=te(ke,[["__scopeId","data-v-644a3feb"]]);export{Le as default};
